// tests/test_parser.c
#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>
#include <string.h>
#include <arpa/inet.h>   // for inet_addr
#include "parser.h"

unsigned char bytes[] = {0x1c, 0xcc, 0xd6, 0xfa, 0x39, 0x1e, 0x8c, 0x90, 0x2d, 0x7b, 0x14, 0xc0, 0x8, 0x6, 0x0, 0x1, 0x8, 0x0, 0x6, 0x4, 0x0, 0x1, 0x8c, 0x90, 0x2d, 0x7b, 0x14, 0xc0, 0xc0, 0xa8, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0xa8, 0x0, 0xaf, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0};

// A minimal mock ARP request packet (Ethernet + ARP)
static uint8_t arp_request_packet[] = {
    // Ethernet header (14 bytes)
    0xff,0xff,0xff,0xff,0xff,0xff,   // dest MAC = ff:ff:ff:ff:ff:ff
    0x00,0x0c,0x29,0xab,0xcd,0xef,   // src MAC  = 00:0c:29:ab:cd:ef
    0x08,0x06,                       // EtherType = ARP (0x0806)

    // ARP header (28 bytes)
    0x00,0x01,   // HTYPE = Ethernet
    0x08,0x00,   // PTYPE = IPv4
    0x06,        // HLEN = 6
    0x04,        // PLEN = 4
    0x00,0x01,   // OPER = 1 (request)
    0x00,0x0c,0x29,0xab,0xcd,0xef,   // Sender MAC
    0xc0,0xa8,0x00,0x64,             // Sender IP = 192.168.0.100
    0x00,0x00,0x00,0x00,0x00,0x00,   // Target MAC = 00:00:00:00:00:00
    0xc0,0xa8,0x00,0x01              // Target IP = 192.168.0.1
};

static void test_parse_arp_request(void **state) {
    (void) state; // unused
    struct arp_info info;

    int ret = parse_arp(arp_request_packet, sizeof(arp_request_packet), &info);
    assert_int_equal(ret, 0);

    // Check operation
    assert_int_equal(ntohs(info.operation), 1);

    // Check sender IP
    assert_int_equal(info.sender_ip, inet_addr("192.168.0.100"));

    // Check target IP
    assert_int_equal(info.target_ip, inet_addr("192.168.0.1"));
}

int main(void) {
    const struct CMUnitTest tests[] = {
        cmocka_unit_test(test_parse_arp_request),
    };
    return cmocka_run_group_tests(tests, NULL, NULL);
}
